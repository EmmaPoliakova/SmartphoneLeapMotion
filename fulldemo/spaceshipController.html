<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width">

        <script src = "../src/peer.js"></script>
        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script src="https://unpkg.com/nipplejs@0.9.0/dist/nipplejs.js"></script>
        <style>
            html, body{
                overflow:hidden;
                background-color: #282145;
            }
            canvas {
                padding: 0;
                margin: auto;
                display: block;
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
            }
            </style>
        
    </head>
    <body>

            <div id="zone_joystick"></div>

            <canvas id = "canvas" width = "640px" height = "400"></canvas>
        
        
            <script>
                peerInitialize();
                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext('2d');

                var background = new Image();
                background.src = "./img/spaceship-600x360.jpg";

                var scalex = Math.abs(window.innerWidth - 640)
                var scaley = window.innerHeight - 400

                var colors = ["#1c8fc2", "#d3332b", "#51a8ac", "#98cc66", "#ffe36e","#9b6dc6"]
                var buttons = {188: {'size': 35, 1:[], 2:[], 3:[], 4:[], 5:[], 6:[]}, 300:{'size': 75, 'land': [140, 300, 215, 375]}}

                background.onload = function(){
                    ctx.drawImage(background, 0,0, canvas.width, canvas.height );  

                    for (i = 0; i<6; i++){
                    ctx.fillStyle = colors[i];
                    ctx.beginPath();
                    ctx.fillRect(154 + i*65, 188, 35, 35);
                    ctx.stroke();

                    buttons[188][i+1] = [154 + i*65, 188, 154 + i*65+35, 188+35]

                }
                    ctx.beginPath();
                    ctx.rect(140, 300, 75, 75);
                    ctx.stroke();
                    ctx.rect(450, 300, 75, 75);
                    ctx.stroke();

                }

                
                  //joystick settings 
                  var jx = 487 + scalex/2
                  var jy = 337 + scaley/2
                  var manager = nipplejs.create({
                    zone: document.getElementById('zone_joystick'),
                    mode: 'static',
                    position: {left: jx + "px", top: jy + "px"},
                    color: 'blue',
                    size: 85
                });

                var joystick = manager.get(manager.id);

                joystick.on("start", function (evt, data) {
                    conn.send({type: 'joystick', data: {type:'start', degrees: null}})
                })
                joystick.on("move", function (evt, data) {
                    conn.send({type: 'joystick', data: {type:'move', degrees: data.angle.degree}})
                })
                joystick.on("end", function (evt, data) {
                    conn.send({type: 'joystick', data: {type:'end', degrees: null}})
                })


                
                function start_handler(ev) {
                    
                    ev.preventDefault();  
                                                 
                    pressButton(ev.targetTouches[0].clientX - scalex/2, ev.targetTouches[0].clientY - scaley/2);
                }

                function move_handler(ev) {

                    ev.preventDefault();
                    

                }

                function end_handler(ev) {
                    ev.preventDefault();    
                    if (ev.targetTouches.length == 0) {
                        // Restore background and outline to original values
                        
                    }
                }

                function set_handlers(e) {
                    // Install event handlers for the given element
                    var el = canvas;
                    el.ontouchstart = start_handler;
                    el.ontouchmove = move_handler;
                    // Use same handler for touchcancel and touchend
                    el.ontouchcancel = end_handler;
                    el.ontouchend = end_handler;
                }

                document.addEventListener("DOMContentLoaded", set_handlers);

                function pressButton (x,y){
                    for (var key in buttons){
                        if (y> parseInt(key) && y< parseInt(key) + buttons[key]['size']){
                            for (var button in buttons[key]){
                                checkButton(button, buttons[key][button], x, y)
                            }
                          
                        }
                    }

                }

                function checkButton(num, corners, x, y){
                    if(x>corners[0] && x<corners[2] && y>corners[1] && y<corners[3]){
                        console.log(num)
                        conn.send({type: 'button', data: num})
                    }
                }
            </script>


    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="style.css">
        <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>       
    </head>
    <body>

        <div id="framesPerSecond" class="fps"></div>


        <center>
        <div id="qrbox" class="modal">
            <div class="modal-content">
                <div class="wrap">

                    <div class="fleft">
                        <div id="qrcode1"></div>
                    </div>

                    <div class="fright">
                        <div id="qrcode2"></div>
                    </div>

            </div>
          </div>
            
        </div>
        </center>
        
            

        <canvas id="drawingCanvas"  style="border:1px solid #000000;"></canvas>

            
        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script type="text/javascript">

            var canvas=document.getElementById("drawingCanvas"),
            ctx = canvas.getContext("2d");
        

            //pup up window with QR
            var qr = document.getElementById("qrbox");
            //var qr2 = document.getElementById("qrbox2");
         

            var colours = ["green", "blue", "red", "yellow", "orange"];
            var fingers = 0;

            // Array of remote peers ID and data channel
            var remotePeerIds=[],// You need this to link with specific DOM element
            connections=[]; // This is where you manage multi-connections

            // count frames variables
            var frames = 0;
            var prevTime = new Date();
            prevTime = prevTime.getTime();

            var fps = document.getElementById("framesPerSecond");

            // create a Peer
            var peer = new Peer(null, {
                    debug: 2
                }); 

            // Get your local peer id
            peer.on('open', function(id) {
            console.log('My peer ID is: ' + id);
            new QRCode(document.getElementById("qrcode1"), "https://emmapoliakova.github.io/SmartphoneLeapMotion/sendMultiplayer.html?id=" + peer.id);
            new QRCode(document.getElementById("qrcode2"), "https://emmapoliakova.github.io/SmartphoneLeapMotion/sendMultiplayer.html?id=" + peer.id);
            qr.style.display = "block";
            
            });


            // Start connection with other peer - and handle it
            function getConnect(remotePeerId){
                var conn = peer.connect(remotePeerId);
                handleConnection(conn);
            };

            // Ok now you need to handle the received connection too
            peer.on('connection',function(conn){
                handleConnection(conn);
            });

            // Handle connection - this is most important part
            function handleConnection(conn){
    
                remotePeerIds.push(conn.peer); // Add remote peer to list

                conn.on('open', function() {
                    console.log("Connected with peer: "+ conn.peer);

                    if (remotePeerIds.length==1){
                        document.getElementById("qrcode1").style.display = "none";
                    }

                    if (remotePeerIds.length==2){
                        //document.getElementById("qrcode2").style.display = "none";
                        qr.style.display = "none";
                    }
                    

                    conn.on('data',function(data){
                    // You can do whatever you want with the data from this connection - this is also the main part
                        processCoordinates(data, remotePeerIds.indexOf(conn.peer));
                   
                    });
                    conn.on('error',function(){
                    // handle error  
                    //connectionError(conn);
                    });

                    conn.on('close',function(){
                    // Handle connection closed
                    //connectionClose(conn);
                    });
                    connections.push(conn);
                });
                
            };
            

            // So now you have multi-connections. If you want to send a message to all other peer, just using for loop with all the connections
            function broadcastMessage(message){
                for(var i=0;i<connections.length;i++){
                    connections[i].send(message);
                }
            }

            // Or if you want to send a message to a specific peer - you need to know his peerid

            function privateMessage(remotePeerId,message){
            for(var i=0;i<connections.length;i++){
                    if(connections[i].peer==remotePeerId){
                    connections[i].send(message);
                    break;
                    }
                }
            }

            function processCoordinates(data, colour) {
            
            //ctx.clearRect(0,0,canvas.width,canvas.height);
            var coordinates = data
            var currentTime = new Date();  
            fingers = coordinates.length;          

            for (var i=0; i < coordinates.length; i++) {
                ctx.beginPath();
                ctx.fillStyle = colours[colour];
                ctx.arc(coordinates[i][0]*canvas.width,coordinates[i][1]*canvas.height,5,0,Math.PI*2);
                ctx.fill();
            }

            framePerSecond(currentTime.getTime());
        }


        function framePerSecond(currentTime){
            if ((currentTime - prevTime)/1000 < 1){
                frames += 1;
            }
            else {
                fps.innerHTML = "FPS: " + frames;
                frames = 1;
                prevTime = currentTime;
                
            }
            
        }



        </script>
    </body>
</html>
